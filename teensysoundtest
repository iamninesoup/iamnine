// Teensy 4.1 ë‚´ì¥ DACë¥¼ ì‚¬ìš©í•œ ì‚¬ì¸íŒŒ ìƒì„±
#include <Audio.h>
#include <Wire.h>
#include <SPI.h>
#include <SD.h>
#include <SerialFlash.h>

// ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
bool streamToPc = false;
bool playChordLoop = false;
float currentFreq = 440.0;
int chordIndex = 0;
unsigned long lastChordChange = 0;

// ìŒê³„ ì£¼íŒŒìˆ˜ ì •ì˜ (4ì˜¥íƒ€ë¸Œ)
float noteFreqs[] = {
  261.63,  // C4 (ë„)
  293.66,  // D4 (ë ˆ)  
  329.63,  // E4 (ë¯¸)
  349.23,  // F4 (íŒŒ)
  392.00,  // G4 (ì†”)
  440.00,  // A4 (ë¼)
  493.88,  // B4 (ì‹œ)
  523.25   // C5 (ë†’ì€ë„)
};

// ë„ë¯¸ì†” ì½”ë“œ
float chordNotes[] = {261.63, 329.63, 392.00}; // C, E, G

// ì˜¤ë””ì˜¤ ê°ì²´ ìƒì„±
AudioSynthWaveformSine   sine1;        // ì‚¬ì¸íŒŒ ìƒì„±ê¸°
AudioSynthWaveformSine   sine2;        // ë‘ ë²ˆì§¸ ì‚¬ì¸íŒŒ (ì˜µì…˜)
AudioOutputAnalog        dac1;         // ë‚´ì¥ DAC ì¶œë ¥ (A14 í•€)
AudioConnection          patchCord1(sine1, 0, dac1, 0);  // ì‚¬ì¸íŒŒ â†’ DAC ì—°ê²°

// ë˜ëŠ” PWM ì¶œë ¥ ì‚¬ìš© (ë” ë†’ì€ í’ˆì§ˆ)
AudioOutputPWM           pwm1;         // PWM ì¶œë ¥
AudioConnection          patchCord2(sine1, 0, pwm1, 0);  // PWM ì¢Œì±„ë„
AudioConnection          patchCord3(sine1, 0, pwm1, 1);  // PWM ìš°ì±„ë„

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  // ì˜¤ë””ì˜¤ ë©”ëª¨ë¦¬ í• ë‹¹
  AudioMemory(10);
  
  // ì¶œë ¥ í•€ ì„¤ì •
  Serial.println("Teensy 4.1 ë‚´ì¥ DAC/PWM ì‚¬ì¸íŒŒ í…ŒìŠ¤íŠ¸ ì‹œì‘");
  Serial.println("");
  Serial.println("ì¶œë ¥ ë°©ë²• ì„ íƒ:");
  Serial.println("1. DAC ì¶œë ¥ - A14 í•€ (0-1.2V, ê³ í’ˆì§ˆ)");
  Serial.println("2. PWM ì¶œë ¥ - í•€ 4,5 (3.3V, í•„í„°ë§ í•„ìš”)");
  Serial.println("");
  Serial.println("í˜„ì¬: ë‘ ë°©ë²• ëª¨ë‘ í™œì„±í™”ë¨");
  Serial.println("");
  
  // ì‚¬ì¸íŒŒ ì„¤ì •
  sine1.amplitude(0.5);    // ë³¼ë¥¨ 50% (0.0 ~ 1.0)
  sine1.frequency(440);    // 440Hz (A4 ìŒí‘œ)
  
  Serial.println("440Hz ì‚¬ì¸íŒŒ ì¶œë ¥ ì¤‘...");
  Serial.println("");
  Serial.println("ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„° ëª…ë ¹ì–´:");
  Serial.println("f[ì£¼íŒŒìˆ˜] - ì˜ˆ: f1000 (1000Hz)");
  Serial.println("a[ì§„í­] - ì˜ˆ: a0.8 (80% ë³¼ë¥¨)");
  Serial.println("s - ì •ì§€");
  Serial.println("r - ì¬ì‹œì‘");
  Serial.println("sweep - ì£¼íŒŒìˆ˜ ìŠ¤ìœ„í”„ í…ŒìŠ¤íŠ¸");
  Serial.println("dual - ë“€ì–¼ í†¤ í…ŒìŠ¤íŠ¸");
  Serial.println("");
}

void loop() {
  // ì‹œë¦¬ì–¼ ëª…ë ¹ì–´ ì²˜ë¦¬
  if (Serial.available()) {
    String command = Serial.readStringUntil('\n');
    command.trim();
    
    if (command.startsWith("f")) {
      // ì£¼íŒŒìˆ˜ ë³€ê²½
      float freq = command.substring(1).toFloat();
      if (freq >= 10 && freq <= 22000) {
        sine1.frequency(freq);
        Serial.println("ì£¼íŒŒìˆ˜: " + String(freq) + "Hz");
      } else {
        Serial.println("ì£¼íŒŒìˆ˜ ë²”ìœ„: 10-22000Hz");
      }
    }
    else if (command.startsWith("a")) {
      // ì§„í­ ë³€ê²½
      float amp = command.substring(1).toFloat();
      if (amp >= 0.0 && amp <= 1.0) {
        sine1.amplitude(amp);
        Serial.println("ì§„í­: " + String(amp * 100) + "%");
      } else {
        Serial.println("ì§„í­ ë²”ìœ„: 0.0-1.0");
      }
    }
    else if (command == "s") {
      // ì •ì§€
      sine1.amplitude(0);
      Serial.println("ì¶œë ¥ ì •ì§€");
    }
    else if (command == "r") {
      // ì¬ì‹œì‘
      sine1.amplitude(0.5);
      Serial.println("ì¶œë ¥ ì¬ì‹œì‘ (440Hz, 50%)");
    }
    else if (command == "sweep") {
      // ì£¼íŒŒìˆ˜ ìŠ¤ìœ„í”„ í…ŒìŠ¤íŠ¸
      Serial.println("ì£¼íŒŒìˆ˜ ìŠ¤ìœ„í”„ í…ŒìŠ¤íŠ¸ ì‹œì‘ (100Hz â†’ 2000Hz, 5ì´ˆ)");
      frequencySweep(100, 2000, 5000);
      Serial.println("ìŠ¤ìœ„í”„ ì™„ë£Œ");
    }
    else if (command == "dual") {
      // ë“€ì–¼ í†¤ í…ŒìŠ¤íŠ¸
      Serial.println("ë“€ì–¼ í†¤ í…ŒìŠ¤íŠ¸ - êµ¬í˜„í•˜ë ¤ë©´ ì½”ë“œ ìˆ˜ì • í•„ìš”");
    }
    else if (command == "stream") {
      // PCë¡œ ì˜¤ë””ì˜¤ ë°ì´í„° ìŠ¤íŠ¸ë¦¬ë°
      streamToPc = !streamToPc;
      Serial.println(streamToPc ? "PC ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘" : "PC ìŠ¤íŠ¸ë¦¬ë° ì •ì§€");
    }
    else if (command == "chord") {
      // ë„ë¯¸ì†” ì½”ë“œ ë°˜ë³µ ì¬ìƒ
      playChordLoop = !playChordLoop;
      Serial.println(playChordLoop ? "ë„ë¯¸ì†” ë°˜ë³µ ì‹œì‘" : "ë„ë¯¸ì†” ë°˜ë³µ ì •ì§€");
      chordIndex = 0;
      lastChordChange = millis();
    }
    else if (command == "scale") {
      // ë„ë ˆë¯¸íŒŒì†”ë¼ì‹œë„ ìŠ¤ì¼€ì¼ ì¬ìƒ
      playScale();
    }
    else if (command == "notes") {
      // ìŒê³„ ì£¼íŒŒìˆ˜ í‘œì‹œ
      printNotes();
    }
    else {
      Serial.println("ì•Œ ìˆ˜ ì—†ëŠ” ëª…ë ¹ì–´: " + command);
      Serial.println("ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´: f[ì£¼íŒŒìˆ˜], a[ì§„í­], s, r, sweep");
    }
  }
  
  // ë„ë¯¸ì†” ì½”ë“œ ë°˜ë³µ ì¬ìƒ
  if (playChordLoop && millis() - lastChordChange > 800) { // 0.8ì´ˆë§ˆë‹¤ ë³€ê²½
    sine1.frequency(chordNotes[chordIndex]);
    Serial.print("â™ª ");
    Serial.print(chordIndex == 0 ? "ë„" : chordIndex == 1 ? "ë¯¸" : "ì†”");
    Serial.print(" (");
    Serial.print(chordNotes[chordIndex]);
    Serial.println("Hz)");
    
    chordIndex = (chordIndex + 1) % 3; // 0,1,2 ìˆœí™˜
    lastChordChange = millis();
  }
  
  // ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
  static unsigned long lastPrint = 0;
  if (millis() - lastPrint > 5000) {  // 5ì´ˆë§ˆë‹¤
    Serial.print("CPU ì‚¬ìš©ë¥ : ");
    Serial.print(AudioProcessorUsage());
    Serial.print("%, ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ : ");
    Serial.print(AudioMemoryUsage());
    Serial.println(" ë¸”ë¡");
    lastPrint = millis();
  }
  
  delay(10);
}

// ì£¼íŒŒìˆ˜ ìŠ¤ìœ„í”„ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
void frequencySweep(float startFreq, float endFreq, unsigned long durationMs) {
  Serial.println("ì£¼íŒŒìˆ˜ ìŠ¤ìœ„í”„: " + String(startFreq) + "Hz â†’ " + String(endFreq) + "Hz");
  
  unsigned long startTime = millis();
  while (millis() - startTime < durationMs) {
    float progress = (float)(millis() - startTime) / durationMs;
    float currentFreq = startFreq + (endFreq - startFreq) * progress;
    sine1.frequency(currentFreq);
    delay(10);
  }
  
  // ì›ë˜ ì£¼íŒŒìˆ˜ë¡œ ë³µê·€
  sine1.frequency(440);
}

// ë„ë ˆë¯¸íŒŒì†”ë¼ì‹œë„ ìŠ¤ì¼€ì¼ ì¬ìƒ í•¨ìˆ˜
void playScale() {
  Serial.println("ğŸµ ë„ë ˆë¯¸íŒŒì†”ë¼ì‹œë„ ì¬ìƒ ì¤‘...");
  
  for (int i = 0; i < 8; i++) {
    sine1.frequency(noteFreqs[i]);
    
    // ìŒê³„ ì´ë¦„ ì¶œë ¥
    String noteNames[] = {"ë„", "ë ˆ", "ë¯¸", "íŒŒ", "ì†”", "ë¼", "ì‹œ", "ë†’ì€ë„"};
    Serial.print("â™ª ");
    Serial.print(noteNames[i]);
    Serial.print(" (");
    Serial.print(noteFreqs[i]);
    Serial.println("Hz)");
    
    delay(600); // 0.6ì´ˆì”© ì¬ìƒ
  }
  
  // ì›ë˜ ì£¼íŒŒìˆ˜ë¡œ ë³µê·€
  sine1.frequency(440);
  Serial.println("ìŠ¤ì¼€ì¼ ì¬ìƒ ì™„ë£Œ - 440Hzë¡œ ë³µê·€");
}

// ìŒê³„ ì£¼íŒŒìˆ˜ ì •ë³´ ì¶œë ¥
void printNotes() {
  Serial.println("=== ìŒê³„ ì£¼íŒŒìˆ˜ ì •ë³´ ===");
  String noteNames[] = {"ë„(C4)", "ë ˆ(D4)", "ë¯¸(E4)", "íŒŒ(F4)", 
                       "ì†”(G4)", "ë¼(A4)", "ì‹œ(B4)", "ë†’ì€ë„(C5)"};
  
  for (int i = 0; i < 8; i++) {
    Serial.print(noteNames[i]);
    Serial.print(": ");
    Serial.print(noteFreqs[i]);
    Serial.println("Hz");
  }
  Serial.println("ë„ë¯¸ì†” ì½”ë“œ: 261.63Hz, 329.63Hz, 392.00Hz");
  Serial.println("=======================");
}

// ê°„ë‹¨í•œ ë©œë¡œë”” ì¬ìƒ í•¨ìˆ˜ (ê¸°ì¡´ í•¨ìˆ˜ ê°œì„ )
void playMelody() {
  float notes[] = {261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88, 523.25}; // C4-C5
  int noteCount = sizeof(notes) / sizeof(notes[0]);
  
  Serial.println("ë„ë ˆë¯¸íŒŒì†”ë¼ì‹œë„ ì¬ìƒ");
  for (int i = 0; i < noteCount; i++) {
    sine1.frequency(notes[i]);
    delay(500);  // 0.5ì´ˆì”© ì¬ìƒ
  }
  sine1.frequency(440);  // 440Hzë¡œ ë³µê·€
}

// íŒŒí˜• ëª¨ë‹ˆí„°ë§ í•¨ìˆ˜ (ë””ë²„ê·¸ìš©)
void printWaveInfo() {
  Serial.println("=== íŒŒí˜• ì •ë³´ ===");
  Serial.print("í˜„ì¬ ì£¼íŒŒìˆ˜: ");
  // sine1.frequency() ê°’ì„ ì§ì ‘ ì½ì„ ìˆ˜ëŠ” ì—†ìœ¼ë¯€ë¡œ ë³€ìˆ˜ë¡œ ì €ì¥í•´ì•¼ í•¨
  Serial.println("Hz");
  Serial.print("í˜„ì¬ ì§„í­: ");
  Serial.println("%");
  Serial.println("================");
}
